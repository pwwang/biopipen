library(rlang)
library(Seurat)
library(tidyseurat)
library(biopipen.utils)

srtfile <- {{in.srtobj | r}}  # nolint
outdir <- {{out.outdir | r}}  # nolint
joboutdir <- {{job.outdir | r}}  # nolint
mutaters <- {{envs.mutaters | r}}  # nolint
group.by <- {{envs["group-by"] | r}}  # nolint
ident.1 <- {{envs["ident-1"] | r}}  # nolint
ident.2 <- {{envs["ident-2"] | r}}  # nolint
each <- {{envs.each | r}}  # nolint
subset <- {{envs.subset | r}}  # nolint
gmtfile <- {{envs.gmtfile | r}}  # nolint
method <- {{envs.method | r}}  # nolint
top <- {{envs.top | r}}  # nolint
minsize <- {{envs.minSize | default: envs.minsize | r}}  # nolint
maxsize <- {{envs.maxSize | default: envs.maxsize | r}}  # nolint
eps <- {{envs.eps | r}}  # nolint
allpathway_plots_defaults <- {{envs.allpathway_plots_defaults | r}}  # nolint
allpathway_plots <- {{envs.allpathway_plots | r}}  #
ncores <- {{envs.ncores | r}}  # nolint
rest <- {{envs.rest | r: todot="-"}}  # nolint
cases <- {{envs.cases | r: todot="-"}}  # nolint

log <- get_logger()
reporter <- get_reporter()

allpathway_plots <- lapply(allpathway_plots, function(x) {
    list_update(allpathway_plots_defaults, x)
})

log$info("Reading Seurat object ...")
srtobj <- read_obj(srtfile)
if (!"Identity" %in% colnames(srtobj@meta.data)) {
    srtobj@meta.data$Identity <- Idents(srtobj)
}

if (!is.null(mutaters) && length(mutaters) > 0) {
    log$info("Mutating metadata columns ...")
    srtobj@meta.data <- srtobj@meta.data %>% mutate(!!!lapply(mutaters, parse_expr))
}

defaults <- list(
    group.by = group.by,
    ident.1 = ident.1,
    ident.2 = ident.2,
    each = each,
    subset = subset,
    gmtfile = gmtfile,
    method = method,
    top = top,
    minsize = minsize,
    maxsize = maxsize,
    eps = eps,
    allpathway_plots_defaults = allpathway_plots_defaults,
    allpathway_plots = allpathway_plots,
    ncores = ncores,
    rest = rest
)

expand_each <- function(name, case) {
    outcases <- list()

    case$group.by <- case$group.by %||% "Identity"

    if (is.null(case$each) || is.na(case$each) || nchar(case$each) == 0 || isFALSE(each)) {
        if (length(case$allpathway_plots) > 0) {
            stop("Cannot perform `allpathway_plots` without `each` defined.")
        }

        outcases[[name]] <- case
    } else {
        eachs <- if (!is.null(case$subset)) {
            srtobj@meta.data %>%
                filter(!!parse_expr(case$subset)) %>%
                pull(case$each) %>% na.omit() %>% unique() %>% as.vector()
        } else {
            srtobj@meta.data %>%
                pull(case$each) %>% na.omit() %>% unique() %>% as.vector()
        }

        if (length(cases) == 0 && name == "GSEA") {
            name <- case$each
        }

        for (each in eachs) {
            newname <- paste0(case$each, "::", each)
            newcase <- case

            newcase$original_case <- paste0(name, " (all ", case$each,")")
            newcase$each_name <- case$each
            newcase$each <- each

            newcase$allpathway_plots_defaults <- NULL
            newcase$allpathway_plots <- NULL

            if (!is.null(case$subset)) {
                newcase$subset <- paste0(case$subset, " & ", bQuote(case$each), " == '", each, "'")
            } else {
                newcase$subset <- paste0(bQuote(case$each), " == '", each, "'")
            }

            outcases[[newname]] <- newcase
        }

        if (length(case$allpathway_plots) > 0) {
            newcase <- case

            newcase$gseas <- list()
            newcase$allpathway_plots <- lapply(
                newcase$allpathway_plots,
                function(x) { list_update(newcase$allpathway_plots_defaults, x) }
            )

            outcases[[paste0(name, " (all ", case$each,")")]] <- newcase
        }
    }
    outcases
}

log$info("Expanding cases...")
cases <- expand_cases(cases, defaults, expand_each, default_case = "GSEA")


ensure_sobj <- function(expr, allow_empty) {
    tryCatch({ expr }, error = function(e) {
        if (allow_empty) {
            log$warn("  Ignoring this case: {e$message}")
            return(NULL)
        } else {
            stop(e)
        }
    })
}

do_case <- function(name) {
    log$info("- Processing case: {name} ...")
    case <- cases[[name]]
    info <- case_info(name, outdir, create = TRUE)

    if (!is.null(case$gseas)) {

        each_levels <- names(case$gseas)
        gseas <- do_call(rbind, lapply(each_levels, function(x) {
            gsea_df <- case$gseas[[x]]
            if (nrow(gsea_df) > 0) {
                gsea_df[[case$each]] <- x
            } else {
                gsea_df[[case$each]] <- character(0)  # Empty case
            }
            gsea_df
        }))
        gseas[[case$each]] <- factor(gseas[[case$each]], levels = each_levels)

        for (plotname in names(case$allpathway_plots)) {
            plotargs <- case$allpathway_plots[[plotname]]
            plotargs <- extract_vars(plotargs, "devpars")
            plotargs$gsea_results <- gseas
            plotargs$group_by <- case$each
            if (plotargs$plot_type == "heatmap") {
                plotargs$show_row_names <- plotargs$show_row_names %||% TRUE
                plotargs$show_column_names <- plotargs$show_column_names %||% TRUE
            }

            p <- do_call(VizGSEA, plotargs)

            outprefix <- file.path(info$prefix, paste0("all.", slugify(plotname)))
            save_plot(p, outprefix, devpars, formats = "png")
            reporter$add2(
                list(kind = "descr", content = paste0("Pathways for all ", case$each, ".")),
                list(kind = "image", src = paste0(outprefix, ".png")),
                hs = c(info$section, info$name),
                hs2 = plotname
            )
        }

        return(invisible(NULL))
    }

    allow_empty = !is.null(case$each)
    # prepare expression matrix
    log$info("  Preparing expression matrix...")
    sobj <- ensure_sobj({ srtobj %>% filter(!is.na(!!sym(case$group.by))) }, allow_empty)
    if (is.null(sobj)) {
        reporter$add2(
            list(
                kind = "error",
                content = paste0("No cells with non-NA `", case$group.by, "` in the Seurat object.")
            ),
            hs = c(info$section, info$name)
        )
        return(NULL)
    }

    if (!is.null(case$subset)) {
        sobj <- ensure_sobj({ sobj %>% filter(!!!parse_exprs(case$subset)) }, allow_empty)
        if (is.null(sobj)) {
            reporter$add2(
                list(
                    kind = "error",
                    content = paste0("No cells with non-NA `", case$group.by, "` in the Seurat object.")
                ),
                hs = c(info$section, info$name)
            )
            return(NULL)
        }
    }
    if (!is.null(case$ident.2)) {
        sobj <- ensure_sobj({ sobj %>% filter(!!sym(case$group.by) %in% c(case$ident.1, case$ident.2)) }, allow_empty)
        if (is.null(sobj)) {
            reporter$add2(
                list(
                    kind = "error",
                    content = paste0("No cells with non-NA `", case$group.by, "` in the Seurat object.")
                ),
                hs = c(info$section, info$name)
            )
            return(NULL)
        }
    }

    allclasses <- sobj@meta.data[, case$group.by, drop = TRUE]
    if (is.null(case$ident.2)) {
        case$ident.2 <- "Other"
        allclasses[allclasses != case$ident.1] <- "Other"
    }
    exprs <- GetAssayData(sobj, layer = "data")

    # get preranks
    log$info("  Getting preranks...")
    ranks <- RunGSEAPreRank(exprs, allclasses, case$ident.1, case$ident.2, case$method)
    write.table(
        as.data.frame(ranks),
        file.path(info$prefix, "fgsea.rank.txt"),
        row.names = TRUE,
        col.names = TRUE,
        sep = "\t",
        quote = FALSE
    )
    if (all(is.na(ranks))) {
        if (length(allclasses) < 100) {
            log$warn("  Ignoring this case because all gene ranks are NA and there are <100 cells.")
            reporter$add2(
                list(
                    kind = "error",
                    content = paste0("Not enough cells (n = ", length(allclasses), ") to run fgsea.")
                ),
                hs = c(info$section, info$name)
            )
            return(NULL)
        } else {
            stop(paste0(
                "All gene ranks are NA (# cells = ",
                length(allclasses),
                "). ",
                "It's probably due to high missing rate in the data. ",
                "You may want to try a different `envs$method` for pre-ranking."
            ))
        }
    }

    # run fgsea
    log$info("  Running fgsea...")
    case$rest$ranks <- ranks
    case$rest$genesets <- ParseGMT(case$gmtfile)
    case$rest$minSize <- case$rest$minSize %||% case$rest$minsize %||% case$minsize
    case$rest$maxSize <- case$rest$maxSize %||% case$rest$maxsize %||% case$maxsize
    case$rest$eps <- case$eps
    case$rest$nproc <- case$ncores
    case$rest$minsize <- NULL
    case$rest$maxsize <- NULL
    result <- do_call(RunGSEA, case$rest)
    write.table(
        result,
        file.path(info$prefix, "fgsea.tsv"),
        row.names = FALSE,
        col.names = TRUE,
        sep = "\t",
        quote = FALSE
    )

    aspect.ratio <- sqrt(case$top) / sqrt(10)
    p_summary <- VizGSEA(
        result,
        plot_type = "summary",
        top_term = case$top,
        aspect.ratio = aspect.ratio
    )
    save_plot(
        p_summary,
        file.path(info$prefix, "summary"),
        devpars = list(res = 100, height = attr(p_summary, "height") * 100 / 1.5, width = attr(p_summary, "width") * 100),
        formats = "png"
    )

    p_gsea <- VizGSEA(
        result,
        plot_type = "gsea",
        gs = result$pathway[1:min(case$top, nrow(result))]
    )
    save_plot(
        p_gsea,
        file.path(info$prefix, "pathways"),
        devpars = list(res = 100, height = attr(p_gsea, "height") * 100, width = attr(p_gsea, "width") * 100),
        formats = "png"
    )


    reporter$add2(
        list(
            name = paste0("Table (", case$ident.1, " vs ", case$ident.2, ")"),
            contents = list(
                list(kind = "descr", content = paste0(
                    "Showing top 50 pathways by padj in descending order. ",
                    "Use 'Download the entire data' button to download all pathways."
                )),
                list(kind = "table", src = file.path(info$prefix, "fgsea.tsv"), data = list(nrows = 50))
            )
        ),
        list(
            name = "Summary Plot",
            contents = list(
                list(kind = "descr", content = paste0("Showing top ", case$top, " pathways.")),
                list(kind = "image", src = file.path(info$prefix, "summary.png"))
            )
        ),
        list(
            name = "GSEA Plots",
            contents = list(
                list(kind = "descr", content = paste0("Showing top ", case$top, " pathways.")),
                list(kind = "image", src = file.path(info$prefix, "pathways.png"))
            )
        ),
        hs = c(info$section, info$name),
        ui = "tabs"
    )

    if (!is.null(case$original_case) && !is.null(cases[[case$original_case]])) {
        cases[[case$original_case]]$gseas[[case$each]] <<- result
    }

    invisible()
}

sapply(names(cases), function(name) do_case(name))

reporter$save(joboutdir)
